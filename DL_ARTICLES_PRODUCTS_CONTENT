AS
BEGIN


    IF(EXISTS(SELECT 1 FROM SYS.TABLES T WHERE T.NAME = 'TMP_DL_article_products_content_2'))
        BEGIN DROP TABLE TMP_DL_article_products_content_2; END

    CREATE TABLE    TMP_DL_article_products_content_2 (created_dt DATETIME, COMPANYID INT, MAIL_LANGUAGEID INT,PRODUCTID   INT,PRODUCTNAME_LONG    NVARCHAR(200),PRODUCTSLUG   NVARCHAR(200),BEFOREPRICE_INCLVAT   FLOAT,PRICE_INCLVAT  FLOAT,COOLBLUESKEUZE    INT,AVAILABILITYSTATEID INT,PRODUCTREVIEWSCORE  INT,PRODUCTREVIEWSCOUNT INT,PRODUCTIMAGE1   INT,PRODUCTIMAGE2  INT,PRODUCTIMAGE3   INT,PRODUCTIMAGE4   INT,PRODUCTIMAGE5   INT,PRODUCTHIGHLIGHTS   NVARCHAR(2000),PRODUCTPROS  NVARCHAR(2000),PRODUCTCONS    NVARCHAR(2000),PRODUCTTYPEID    INT,PRODUCTTYPESINGULAR NVARCHAR(100),PRODUCTTYPEPLURAL NVARCHAR(100),PRODUCTTYPESLUG   NVARCHAR(200),BRANDID    INT,BRANDNAME   NVARCHAR(100),BRANDSLUG NVARCHAR(200), IMAGE_PRODUCTSPECIALIST INT,  PRODUCTNAME NVARCHAR(50), PROMOTION_TITLE_CUSTOM NVARCHAR(200), PROMOTION_LABEL_CUSTOM NVARCHAR(200), IMAGE_URL_CUSTOM NVARCHAR(200), subproducttypeid INT, subproducttypename NVARCHAR(200), leaderboard_background_image_desktop NVARCHAR(200), leaderboard_background_image_mobile NVARCHAR(200), sf_product_landing_page_url NVARCHAR(200), collection_id INT, promotion_label_automatic NVARCHAR(200))

insert into TMP_DL_article_products_content_2 (CREATED_DT, companyid, MAIL_LANGUAGEID ,PRODUCTID ,PRODUCTNAME_LONG ,PRODUCTSLUG ,BEFOREPRICE_INCLVAT ,PRICE_INCLVAT ,COOLBLUESKEUZE ,AVAILABILITYSTATEID, PRODUCTREVIEWSCORE ,PRODUCTREVIEWSCOUNT ,PRODUCTIMAGE1 ,PRODUCTIMAGE2 ,PRODUCTIMAGE3 ,PRODUCTIMAGE4 ,PRODUCTIMAGE5 ,PRODUCTHIGHLIGHTS ,PRODUCTPROS,PRODUCTCONS ,PRODUCTTYPEID ,PRODUCTTYPESINGULAR ,PRODUCTTYPEPLURAL ,PRODUCTTYPESLUG ,BRANDID ,BRANDNAME ,BRANDSLUG,IMAGE_PRODUCTSPECIALIST , PRODUCTNAME, PROMOTION_TITLE_CUSTOM, PROMOTION_LABEL_CUSTOM, IMAGE_URL_CUSTOM, subproducttypeid,subproducttypename,leaderboard_background_image_desktop,leaderboard_background_image_mobile,sf_product_landing_page_url, collection_id, promotion_label_automatic)

    SELECT DISTINCT
        getdate() as created_dt,
        case 
            when mail_language_id in (1,4) then 1
            when mail_language_id in (2,3,5) then 2
        end as companyid,
        t.mail_language_id as mail_languageid,
        t.id as productid,
        t.productname_long,
        t.productslug,
        t.beforeprice as BEFOREPRICE_INCLVAT,
        t.price as PRICE_INCLVAT,
        t.coolblueskeuze,
        t.availabilitystateid,
        CASE
            WHEN T.productreviewscore BETWEEN '0' AND '0.4' THEN 0
            WHEN T.productreviewscore BETWEEN '0.5' AND '1.4' THEN 05
            WHEN T.productreviewscore BETWEEN '1.5' AND '2.4' THEN 10
            WHEN T.productreviewscore BETWEEN '2.5' AND '3.4' THEN 15
            WHEN T.productreviewscore BETWEEN '3.5' AND '4.4' THEN 20
            WHEN T.productreviewscore BETWEEN '4.5' AND '5.4' THEN 25
            WHEN T.productreviewscore BETWEEN '5.5' AND '6.4' THEN 30
            WHEN T.productreviewscore BETWEEN '6.5' AND '7.4' THEN 35
            WHEN T.productreviewscore BETWEEN '7.5' AND '8.4' THEN 40
            WHEN T.productreviewscore BETWEEN '8.5' AND '9.4' THEN 45
            WHEN T.productreviewscore >= '9.5' THEN 50 ELSE 0
            END AS PRODUCTREVIEWSCORE,
        t.productreviewscount,
        t.productimage1,
        t.productimage2,
        t.productimage3,
        t.productimage4,
        t.productimage5,
        t.producthighlights,
        REPLACE(T.PRODUCTPROS, '<br />', ' ') AS PRODUCTPROS,
        REPLACE(T.PRODUCTCONS, '<br />', ' ') AS PRODUCTCONS,
        t.producttypeid,
        lower(t.producttypesingular) as producttypesingular,
        lower(t.producttypeplural) as producttypeplural,
        t.producttypeslug,
        t.brandid,
        t.brandname,
        t.brandslug,
        case
            when sp.available=1 then sp.specialistimageid
            else null
            end as image_productspecialist,
        t.productname,
        t.promotion_title_custom_productid as promotion_title_custom,
        t.promotion_label_custom_productid as promotion_label_custom,
        t.image_url_custom,

        -- Everything below this line is new.
        t.subproducttypeid,
        t.subproducttypename,
        t.leaderboard_background_image_desktop,
        t.leaderboard_background_image_mobile,
        t.sf_product_landing_page_url,
        t.collectionid as collection_id,
        case
            when sf_product_promotion_type_id like 'S2' then 'pre-order ''m nu.'
            when sf_product_promotion_type_id like 'S3' then 'spiksplinternieuw'
            when sf_product_promotion_type_id like 'S4' then 'vriendenprijs'
            when sf_product_promotion_type_id like 'S5' then concat('nu â‚¬',t.sf_product_discount_euro,',- cashback')
            when sf_product_promotion_type_id like 'S6' then concat('nu met gratis ',apc.productname)
            when sf_product_promotion_type_id like 'S7' then conCat('onze keuze voor ',apc.productname)
            when sf_product_promotion_type_id like 'M3' then null
            when sf_product_promotion_type_id like 'M4' then null
            when sf_product_promotion_type_id like 'M5' then null
            when sf_product_promotion_type_id like 'M6' then null
        end as promotion_label_automatic
    FROM
        tmp_dl_articles_products_content T
    LEFT JOIN
        DATA_IMAGES_PRODUCTSPECIALIST SP WITH (NOLOCK)
    ON
        T.PRODUCTTYPEID = SP.PRODUCTTYPEID
    left join
        articles_products_content apc with (nolock)
    on
        t.sf_gratis_metje_product_id = apc.productid
        and t.mail_language_id = apc.mail_languageid


	-- UPDATE THE PROMO COLUMNS TO BE EMPTY.
	BEGIN TRANSACTION

	UPDATE ARTICLES_PRODUCTS_CONTENT_test
	SET			PROMOTION_TITLE_CUSTOM = NULL
				,PROMOTION_LABEL_CUSTOM = NULL
				,IMAGE_URL_CUSTOM = NULL
				,promotion_label_automatic = NULL
				,sf_product_landing_page_url = NULL

	IF(@@ERROR<>0)
	BEGIN
	ROLLBACK;
	RETURN 1;
	END

-- UPDATE ARTICLES_PRODUCTS_CONTENT TABLE
    MERGE  ARTICLES_PRODUCTS_CONTENT_test AS ORG
    USING  TMP_DL_article_products_content_2 AS T
    ON T.PRODUCTID = ORG.PRODUCTID AND T.MAIL_LANGUAGEID=ORG.MAIL_LANGUAGEID
    WHEN MATCHED
        AND ISNULL(ORG.PRODUCTNAME_LONG, 0) <> T.PRODUCTNAME_LONG
        OR ISNULL(ORG.PRODUCTSLUG, 0) <> T.PRODUCTSLUG
        OR ISNULL(ORG.BEFOREPRICE_INCLVAT, 0) <> T.BEFOREPRICE_INCLVAT
        OR ISNULL(ORG.PRICE_INCLVAT, 0) <> T.PRICE_INCLVAT
        OR ISNULL(ORG.COOLBLUESKEUZE, 0) <> T.COOLBLUESKEUZE
        OR ISNULL(ORG.AVAILABILITYSTATEID, 0) <> T.AVAILABILITYSTATEID
        OR ISNULL(ORG.PRODUCTREVIEWSCORE, 0) <> T.PRODUCTREVIEWSCORE
        OR ISNULL(ORG.PRODUCTREVIEWSCOUNT, 0) <> T.PRODUCTREVIEWSCOUNT
        OR ISNULL(ORG.PRODUCTIMAGE1, 0) <> T.PRODUCTIMAGE1
        OR ISNULL(ORG.PRODUCTIMAGE2, 0) <> T.PRODUCTIMAGE2
        OR ISNULL(ORG.PRODUCTIMAGE3, 0) <> T.PRODUCTIMAGE3
        OR ISNULL(ORG.PRODUCTIMAGE4, 0) <> T.PRODUCTIMAGE4
        OR ISNULL(ORG.PRODUCTIMAGE5, 0) <> T.PRODUCTIMAGE5
        OR ISNULL(ORG.PRODUCTHIGHLIGHTS, 0) <> T.PRODUCTHIGHLIGHTS
        OR ISNULL(ORG.PRODUCTPROS, 0) <> T.PRODUCTPROS
        OR ISNULL(ORG.PRODUCTCONS, 0) <> T.PRODUCTCONS
        OR ISNULL(ORG.PRODUCTTYPEID, 0) <> T.PRODUCTTYPEID
        OR ISNULL(ORG.PRODUCTTYPESINGULAR, 0) <> T.PRODUCTTYPESINGULAR
        OR ISNULL(ORG.PRODUCTTYPEPLURAL, 0) <> T.PRODUCTTYPEPLURAL
        OR ISNULL(ORG.PRODUCTTYPESLUG, 0) <> T.PRODUCTTYPESLUG
        OR ISNULL(ORG.BRANDID, 0) <> T.BRANDID
        OR ISNULL(ORG.BRANDNAME, 0) <> T.BRANDNAME
        OR ISNULL(ORG.BRANDSLUG, 0) <> T.BRANDSLUG
        OR ISNULL(ORG.IMAGE_PRODUCTSPECIALIST, 0) <> T.IMAGE_PRODUCTSPECIALIST
        OR ISNULL(ORG.PRODUCTNAME, 0) <> T.PRODUCTNAME
        OR ISNULL(ORG.PROMOTION_TITLE_CUSTOM, 0) <> T.PROMOTION_TITLE_CUSTOM
        OR ISNULL(ORG.PROMOTION_LABEL_CUSTOM, 0) <> T.PROMOTION_LABEL_CUSTOM
        OR ISNULL(ORG.IMAGE_URL_CUSTOM, 0) <> T.IMAGE_URL_CUSTOM
        OR ISNULL(ORG.subproducttypeid, 0) <> t.subproducttypeid
        OR ISNULL(ORG.subproducttypename, 0) <> t.subproducttypename
        OR ISNULL(ORG.promotion_label_automatic, 0) <> t.promotion_label_automatic
        OR ISNULL(ORG.leaderboard_background_image_desktop, 0) <> t.leaderboard_background_image_desktop
        OR ISNULL(ORG.leaderboard_background_image_mobile, 0) <> t.leaderboard_background_image_mobile
        OR ISNULL(ORG.sf_product_landing_page_url, 0) <> t.sf_product_landing_page_url
        OR ISNULL(ORG.collection_id, 0) <> t.collection_id

    THEN UPDATE SET
        ORG.MODIFIED_DT = T.created_dt
        ,ORG.COMPANYID = T.COMPANYID
        ,ORG.PRODUCTNAME_LONG = T.PRODUCTNAME_LONG
        ,ORG.PRODUCTSLUG = T.PRODUCTSLUG
        ,ORG.BEFOREPRICE_INCLVAT = T.BEFOREPRICE_INCLVAT
        ,ORG.PRICE_INCLVAT = T.PRICE_INCLVAT
        ,ORG.COOLBLUESKEUZE = T.COOLBLUESKEUZE
        ,ORG.AVAILABILITYSTATEID = T.AVAILABILITYSTATEID
        ,ORG.PRODUCTREVIEWSCORE = T.PRODUCTREVIEWSCORE
        ,ORG.PRODUCTREVIEWSCOUNT = T.PRODUCTREVIEWSCOUNT
        ,ORG.PRODUCTIMAGE1 = T.PRODUCTIMAGE1
        ,ORG.PRODUCTIMAGE2 = T.PRODUCTIMAGE2
        ,ORG.PRODUCTIMAGE3 = T.PRODUCTIMAGE3
        ,ORG.PRODUCTIMAGE4 = T.PRODUCTIMAGE4
        ,ORG.PRODUCTIMAGE5 = T.PRODUCTIMAGE5
        ,ORG.PRODUCTHIGHLIGHTS = T.PRODUCTHIGHLIGHTS
        ,ORG.PRODUCTPROS = T.PRODUCTPROS
        ,ORG.PRODUCTCONS = T.PRODUCTCONS
        ,ORG.PRODUCTTYPEID = T.PRODUCTTYPEID
        ,ORG.PRODUCTTYPESINGULAR = T.PRODUCTTYPESINGULAR
        ,ORG.PRODUCTTYPEPLURAL = T.PRODUCTTYPEPLURAL
        ,ORG.PRODUCTTYPESLUG = T.PRODUCTTYPESLUG
        ,ORG.BRANDID = T.BRANDID
        ,ORG.BRANDNAME = T.BRANDNAME
        ,ORG.BRANDSLUG = T.BRANDSLUG
        ,ORG.IMAGE_PRODUCTSPECIALIST = T.IMAGE_PRODUCTSPECIALIST
        ,ORG.PRODUCTNAME = T.PRODUCTNAME
        ,ORG.PROMOTION_TITLE_CUSTOM = T.PROMOTION_TITLE_CUSTOM
        ,ORG.PROMOTION_LABEL_CUSTOM = T.PROMOTION_LABEL_CUSTOM
        ,ORG.IMAGE_URL_CUSTOM = T.IMAGE_URL_CUSTOM
        ,ORG.subproducttypeid = t.subproducttypeid
        ,ORG.subproducttypename = t.subproducttypename
        ,ORG.promotion_label_automatic = t.promotion_label_automatic
        ,ORG.leaderboard_background_image_desktop = t.leaderboard_background_image_desktop
        ,ORG.leaderboard_background_image_mobile = t.leaderboard_background_image_mobile
        ,ORG.sf_product_landing_page_url = t.sf_product_landing_page_url
        ,ORG.collection_id = t.collection_id
    WHEN NOT MATCHED BY TARGET
    THEN INSERT
        (CREATED_DT, companyid, MAIL_LANGUAGEID ,PRODUCTID ,PRODUCTNAME_LONG ,PRODUCTSLUG ,BEFOREPRICE_INCLVAT ,PRICE_INCLVAT ,COOLBLUESKEUZE ,AVAILABILITYSTATEID, PRODUCTREVIEWSCORE ,PRODUCTREVIEWSCOUNT ,PRODUCTIMAGE1 ,PRODUCTIMAGE2 ,PRODUCTIMAGE3 ,PRODUCTIMAGE4 ,PRODUCTIMAGE5 ,PRODUCTHIGHLIGHTS ,PRODUCTPROS,PRODUCTCONS ,PRODUCTTYPEID ,PRODUCTTYPESINGULAR ,PRODUCTTYPEPLURAL ,PRODUCTTYPESLUG ,BRANDID ,BRANDNAME ,BRANDSLUG,IMAGE_PRODUCTSPECIALIST , PRODUCTNAME, PROMOTION_TITLE_CUSTOM, PROMOTION_LABEL_CUSTOM, IMAGE_URL_CUSTOM, subproducttypeid,subproducttypename,promotion_label_automatic,leaderboard_background_image_desktop,leaderboard_background_image_mobile,sf_product_landing_page_url,collection_id)
    VALUES
        (T.created_dt, T.companyid, T.MAIL_LANGUAGEID ,T.PRODUCTID ,T.PRODUCTNAME_LONG ,T.PRODUCTSLUG ,T.BEFOREPRICE_INCLVAT ,T.PRICE_INCLVAT ,T.COOLBLUESKEUZE ,T.AVAILABILITYSTATEID,T.PRODUCTREVIEWSCORE ,T.PRODUCTREVIEWSCOUNT ,T.PRODUCTIMAGE1 ,T.PRODUCTIMAGE2 ,T.PRODUCTIMAGE3 ,T.PRODUCTIMAGE4 ,T.PRODUCTIMAGE5 ,T.PRODUCTHIGHLIGHTS ,T.PRODUCTPROS,T.PRODUCTCONS ,T.PRODUCTTYPEID ,T.PRODUCTTYPESINGULAR ,T.PRODUCTTYPEPLURAL ,T.PRODUCTTYPESLUG ,T.BRANDID ,T.BRANDNAME ,T.BRANDSLUG,T.IMAGE_PRODUCTSPECIALIST , T.PRODUCTNAME, T.PROMOTION_TITLE_CUSTOM, T.PROMOTION_LABEL_CUSTOM, T.IMAGE_URL_CUSTOM,T.subproducttypeid,T.subproducttypename,T.promotion_label_automatic,t.leaderboard_background_image_desktop,t.leaderboard_background_image_mobile,t.sf_product_landing_page_url, t.collection_id);

-- UPDATE ORIGINAL ARTICLES_PRODUCTS TABLE AND GIVE INDICATION WHETHER PRODUCT IS AVAILABLE IN PRODUCTSUP AND THUS CONTENT TABLE
--    MERGE  ARTICLES_PRODUCTS  AS ORG
--    USING  TMP_DL_CONTENT_PRODUCTINFO_NL_2  AS T2
--    ON T2.PRODUCTID = ORG.PRODUCTID AND T2.COMPANYID=ORG.COMPANYID
--    WHEN MATCHED
--        AND ORG.AVAILABLE_CONTENT IS NULL
--    THEN UPDATE
--    SET
--        ORG.AVAILABLE_CONTENT=1 ;

IF(@@ERROR<>0)
BEGIN
ROLLBACK;
RETURN 2;
END

COMMIT
RETURN 0;

END
